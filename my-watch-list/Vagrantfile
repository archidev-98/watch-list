Vagrant.configure("2") do |config|
  config.ssh.insert_key = true
  config.vm.box = "ubuntu/focal64"

  # Configuration commune pour tous les nodes
  config.vm.provider "virtualbox" do |vb|
    vb.memory = 2048
    vb.cpus = 2
  end

  # =========================
  # NODE 1 - Serveur K3s + Docker
  # =========================
  config.vm.define "node1" do |node1|
    node1.vm.hostname = "node1"
    node1.vm.network "private_network", ip: "192.168.56.10"

    node1.vm.provision "shell", inline: <<-SHELL
      # Installer K3s serveur
      curl -sfL https://get.k3s.io | sh -
      sudo cat /var/lib/rancher/k3s/server/node-token > /vagrant/node-token

      # Installer Docker
      sudo apt update
      sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
      sudo apt update
      sudo apt install -y docker-ce docker-ce-cli containerd.io
      sudo usermod -aG docker vagrant

      # Initialiser Docker Swarm
      docker swarm init --advertise-addr 192.168.56.10
      docker swarm join-token worker -q > /vagrant/swarm_token
    SHELL
  end

  # =========================
  # NODE 2 - Agent K3s + Docker
  # =========================
  config.vm.define "node2" do |node2|
    node2.vm.hostname = "node2"
    node2.vm.network "private_network", ip: "192.168.56.11"

    node2.vm.provision "shell", inline: <<-SHELL
      # Attendre le token K3s
      while [ ! -f /vagrant/node-token ]; do sleep 5; done
      TOKEN=$(cat /vagrant/node-token)
      curl -sfL https://get.k3s.io | K3S_URL=https://192.168.56.10:6443 K3S_TOKEN=$TOKEN sh -

      # Installer Docker
      sudo apt update
      sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
      sudo apt update
      sudo apt install -y docker-ce docker-ce-cli containerd.io
      sudo usermod -aG docker vagrant

      # Rejoindre le Docker Swarm
      while [ ! -f /vagrant/swarm_token ]; do sleep 5; done
      TOKEN=$(cat /vagrant/swarm_token)
      docker swarm join --token $TOKEN 192.168.56.10:2377
    SHELL
  end

  # =========================
  # NODE 3 - Agent K3s + Docker
  # =========================
  config.vm.define "node3" do |node3|
    node3.vm.hostname = "node3"
    node3.vm.network "private_network", ip: "192.168.56.12"

    node3.vm.provision "shell", inline: <<-SHELL
      # Attendre le token K3s
      while [ ! -f /vagrant/node-token ]; do sleep 5; done
      TOKEN=$(cat /vagrant/node-token)
      curl -sfL https://get.k3s.io | K3S_URL=https://192.168.56.10:6443 K3S_TOKEN=$TOKEN sh -

      # Installer Docker
      sudo apt update
      sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
      sudo apt update
      sudo apt install -y docker-ce docker-ce-cli containerd.io
      sudo usermod -aG docker vagrant

      # Rejoindre le Docker Swarm
      while [ ! -f /vagrant/swarm_token ]; do sleep 5; done
      TOKEN=$(cat /vagrant/swarm_token)
      docker swarm join --token $TOKEN 192.168.56.10:2377
    SHELL
  end
end